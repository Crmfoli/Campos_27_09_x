<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dados dos Sensores</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f6f9; margin: 0; padding: 0; }
        header { background-color: #007bff; color: white; padding: 15px; text-align: center; font-size: 22px; }
        .container { width: 90%; margin: 20px auto; }
        .info-header { text-align: center; margin-bottom: 15px; }
        .info-header h2 { margin: 0; font-size: 1.2em; color: #333; font-weight: bold; }
        .info-header p { margin: 4px 0 0; font-size: 1em; color: #555; }
        .grafico-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .grafico-container canvas { max-height: 50vh; }
        .loading { text-align: center; padding: 20px; font-size: 18px; color: #333; }
        .filter-container { margin-bottom: 20px; }
        .filter-container label { font-weight: bold; margin-right: 10px; }
        .filter-container select { padding: 5px; font-size: 1em; border-radius: 4px; }
        /* Estilos para o botão de voltar */
        .nav-container {
            margin-bottom: 20px;
            text-align: right;
        }
        .btn {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color: 0.3s ease;
        }
        .btn:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <header>ESTAÇÕES GEOTÉCNICAS</header>
    <div class="container">
        <!-- Botão para voltar ao mapa -->
        <div class="nav-container">
            <button id="voltar-btn" class="btn">Voltar ao Mapa e Continuar</button>
        </div>

        <div class="grafico-container" id="pluviometria-container">
            <div class="filter-container">
                <label for="periodo-filtro-pluviometria">Período:</label>
                <select id="periodo-filtro-pluviometria"><option value="1">1 hora</option><option value="3">3 horas</option><option value="6">6 horas</option><option value="12">12 horas</option><option value="24">24 horas</option><option value="48">48 horas</option><option value="72" selected>72 horas</option><option value="96">96 horas</option></select>
            </div>
            <div class="info-header"><h2>Município: CAMPOS DO JORDÃO/SP</h2><p>Estação: Vila Abernéssia</p></div>
            <canvas id="graficoPluviometria"></canvas>
            <div class="loading" id="loading-pluviometria">Carregando dados...</div>
        </div>
        <div class="grafico-container" id="sensores-container">
            <div class="filter-container">
                <label for="periodo-filtro-sensores">Período:</label>
                <select id="periodo-filtro-sensores"><option value="1">1 hora</option><option value="3">3 horas</option><option value="6">6 horas</option><option value="12">12 horas</option><option value="24">24 horas</option><option value="48">48 horas</option><option value="72" selected>72 horas</option><option value="96">96 horas</option></select>
            </div>
            <div class="info-header"><h2>Município: CAMPOS DO JORDÃO/SP</h2><p>Estação: Vila Abernéssia</p></div>
            <canvas id="graficoSensores"></canvas>
            <div class="loading" id="loading-sensores">Carregando dados...</div>
        </div>
    </div>
    <script>
        let graficoSensores, graficoPluviometria;
        let todosOsDadosSensores = [], todosOsDadosPluviometria = [];
        const indiceSimulacao = {{ indice_simulacao|default('null') }};
        
        const ESTILOS_SENSORES = [ { color: 'rgb(128, 0, 128)', pointStyle: 'circle' }, { color: 'rgb(0, 0, 255)', pointStyle: 'circle' }, { color: 'rgb(0, 128, 0)', pointStyle: 'rect' }, { color: 'rgb(255, 165, 0)', pointStyle: 'triangle' }, { color: 'rgb(255, 0, 0)', pointStyle: 'rectRot' }, { color: 'rgb(255, 0, 255)', pointStyle: 'star' } ];
        const LABELS_PROFUNDIDADE = ['Profundidade 0,3 m', 'Profundidade 0,8 m', 'Profundidade 1,5 m', 'Profundidade 2,0 m', 'Profundidade 2,5 m'];
        const ESTILO_PRECIPITACAO = { type: 'bar', color: 'rgba(54, 162, 235, 0.6)', borderColor: 'rgba(54, 162, 235, 1)' };
        const verticalLinePlugin = { id: 'verticalLine', afterDraw: (chart) => { if (chart.tooltip?._active?.length) { const ctx = chart.ctx; const x = chart.tooltip._active[0].element.x; const topY = chart.scales.y.top; const bottomY = chart.scales.y.bottom; ctx.save(); ctx.beginPath(); ctx.moveTo(x, topY); ctx.lineTo(x, bottomY); ctx.lineWidth = 1; ctx.strokeStyle = 'rgba(0, 0, 0, 0.7)'; ctx.stroke(); ctx.restore(); } } };

        function formatarDataBR(dataStr) {
            if (!dataStr) return '';
            const [data, hora] = dataStr.split(' ');
            const [ano, mes, dia] = data.split('-');
            const [h, m] = hora.split(':');
            return `${dia}/${mes}/${ano} ${h}:${m}`;
        }
        
        async function carregarDadosIniciais() {
            try {
                const [respSensores, respPluviometria] = await Promise.all([fetch("/dados_json"), fetch("/pluviometria_json")]);
                let dadosSensoresCompletos = await respSensores.json(); 
                let dadosPluviometriaCompletos = await respPluviometria.json();

                if (indiceSimulacao !== null && indiceSimulacao >= 0) {
                    todosOsDadosSensores = dadosSensoresCompletos.slice(0, indiceSimulacao + 1);
                    todosOsDadosPluviometria = dadosPluviometriaCompletos.slice(0, indiceSimulacao + 1);
                } else {
                    todosOsDadosSensores = dadosSensoresCompletos;
                    todosOsDadosPluviometria = dadosPluviometriaCompletos;
                }

                if (todosOsDadosSensores.length === 0) throw new Error("Dados não encontrados.");
                iniciarGraficos(); 
                atualizarGraficoPluviometria();
                atualizarGraficoSensores();
            } catch (error) { console.error("Erro:", error.message); }
        }

        function atualizarGraficoPluviometria() {
            const horas = parseInt(document.getElementById('periodo-filtro-pluviometria').value);
            if (todosOsDadosPluviometria.length === 0) return;

            const dataFinal = new Date(todosOsDadosPluviometria[todosOsDadosPluviometria.length - 1].data_hora);
            const limiteInferior = new Date(dataFinal.getTime() - horas * 60 * 60 * 1000);
            const dadosFinais = todosOsDadosPluviometria.filter(d => new Date(d.data_hora) >= limiteInferior);
            
            renderizarGraficoPluviometria(dadosFinais);
        }

        function atualizarGraficoSensores() {
            const horas = parseInt(document.getElementById('periodo-filtro-sensores').value);
            if (todosOsDadosSensores.length === 0) return;
            
            const dataFinal = new Date(todosOsDadosSensores[todosOsDadosSensores.length - 1].data_hora);
            const limiteInferior = new Date(dataFinal.getTime() - horas * 60 * 60 * 1000);
            const dadosFinais = todosOsDadosSensores.filter(d => new Date(d.data_hora) >= limiteInferior);

            renderizarGraficoSensores(dadosFinais);
        }

        function renderizarGrafico(grafico, dados, labels, datasets) {
            if (!grafico || !dados) return;
            if (dados.length === 0) {
                grafico.data.labels = [];
                grafico.data.datasets.forEach(ds => { ds.data = []; });
            } else {
                grafico.data.labels = labels;
                datasets.forEach((ds, i) => { if(grafico.data.datasets[i]) grafico.data.datasets[i].data = ds; });
            }
            grafico.update();
        }

        function renderizarGraficoSensores(dados) {
            document.getElementById('loading-sensores').style.display = 'none';
            const labels = dados.map(d => formatarDataBR(d.data_hora));
            const datasets = LABELS_PROFUNDIDADE.map((_, i) => dados.map(d => d[Object.keys(d)[i+1]]));
            renderizarGrafico(graficoSensores, dados, labels, datasets);
        }

        function renderizarGraficoPluviometria(dados) {
            document.getElementById('loading-pluviometria').style.display = 'none';
            const labels = dados.map(d => formatarDataBR(d.data_hora));
            
            let acumuladoVisivel = 0;
            const dadosAcumuladosVisiveis = dados.map(d => {
                acumuladoVisivel += (d['Precipitação'] || 0);
                return acumuladoVisivel.toFixed(2);
            });

            const datasets = [
                dados.map(d => d['Precipitação']),
                dadosAcumuladosVisiveis
            ];

            renderizarGrafico(graficoPluviometria, dados, labels, datasets);
        }

        function iniciarGraficos() {
            const ctxSensores = document.getElementById('graficoSensores').getContext('2d');
            graficoSensores = new Chart(ctxSensores, { type: 'line', data: { datasets: LABELS_PROFUNDIDADE.map((l, i) => ({ label: l, borderColor: ESTILOS_SENSORES[i].color, backgroundColor: ESTILOS_SENSORES[i].color, pointRadius: 0, pointHoverRadius: 5, tension: 0.1 }))}, options: { responsive: true, maintainAspectRatio: false, animation: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { position: 'bottom' }, tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${(ctx.parsed.y * 100).toFixed(2)}%` }}}, scales: { y: { title: { display: true, text: 'Umidade Volumetrica (%)' }, ticks: { callback: (val) => `${(val * 100).toFixed(0)}%` }}} }, plugins: [verticalLinePlugin] });
            
            const ctxPluviometria = document.getElementById('graficoPluviometria').getContext('2d');
            graficoPluviometria = new Chart(ctxPluviometria, { type: 'bar', data: { datasets: [ 
                { label: 'Pluviometria (mm)', type: 'bar', backgroundColor: ESTILO_PRECIPITACAO.color }, 
                { label: 'Precipitação Acumulada no Período', type: 'line', borderColor: 'rgb(0,0,0)', pointRadius: 0, pointHoverRadius: 5, tension: 0.1 } 
            ] }, options: { responsive: true, maintainAspectRatio: false, animation: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { position: 'bottom' } }, scales: { y: { title: { display: true, text: 'Pluviometria (mm)' } } } }, plugins: [verticalLinePlugin] });
        }

        // Adiciona o evento de clique ao botão de voltar
        document.getElementById('voltar-btn').addEventListener('click', () => {
            window.close(); // Simplesmente fecha a janela/aba
        });

        document.addEventListener('DOMContentLoaded', carregarDadosIniciais);
        document.getElementById('periodo-filtro-pluviometria').addEventListener('change', atualizarGraficoPluviometria);
        document.getElementById('periodo-filtro-sensores').addEventListener('change', atualizarGraficoSensores);
    </script>
</body>
</html>
