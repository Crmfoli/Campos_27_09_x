<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dados dos Sensores</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f6f9; margin: 0; padding: 0; }
        header { background-color: #007bff; color: white; padding: 15px; text-align: center; font-size: 22px; }
        .container { width: 90%; margin: 20px auto; }
        .grafico-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        table th, table td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        table th { background-color: #007bff; color: white; }
        .loading { text-align: center; padding: 20px; font-size: 18px; color: #333; }
        h2 { text-align: center; color: #333; font-weight: 500; }
    </style>
</head>
<body>
    <header>üìä Dados de Monitoramento</header>

    <div class="container">
        <div class="grafico-container">
            <h2>Esta√ß√£o Meteorol√≥gica</h2>
            <canvas id="graficoPluviometria"></canvas>
        </div>

        <div class="grafico-container">
            <h2>Umidade do Solo</h2>
            <canvas id="graficoSensores"></canvas>
        </div>

        <div id="tabela-container">
            <div class="loading">A carregar dados...</div>
        </div>
    </div>

    <script>
        // --- Vari√°veis e Configura√ß√µes Globais ---
        let todosOsDadosSensores = [], indiceAtualSensores = 0, dadosNaTelaSensores = [], graficoSensores = null;
        let todosOsDadosPluviometria = [], indiceAtualPluviometria = 0, dadosNaTelaPluviometria = [], graficoPluviometria = null;
        let intervalId = null;

        // Estilos para o gr√°fico de SENSORES DE UMIDADE
        const ESTILOS_SENSORES = [
            { color: 'rgb(128, 0, 128)', pointStyle: 'circle' }, { color: 'rgb(0, 0, 255)', pointStyle: 'circle' },
            { color: 'rgb(0, 128, 0)', pointStyle: 'rect' }, { color: 'rgb(255, 165, 0)', pointStyle: 'triangle' },
            { color: 'rgb(255, 0, 0)', pointStyle: 'rectRot' }, { color: 'rgb(255, 0, 255)', pointStyle: 'star' }
        ];
        const LABELS_PROFUNDIDADE = ['Profundidade 0,3 m', 'Profundidade 0,8 m', 'Profundidade 1,5 m', 'Profundidade 2,0 m', 'Profundidade 2,5 m'];

        // ALTERA√á√ÉO: Estilos para o novo gr√°fico da ESTA√á√ÉO METEOROL√ìGICA (ajustados para a combina√ß√£o de tipos)
        const ESTILOS_ESTACAO = {
            'Precipita√ß√£o': { type: 'bar', color: 'rgba(54, 162, 235, 0.6)', borderColor: 'rgba(54, 162, 235, 1)', pointStyle: 'rect', yAxisID: 'y' },
            'Precipita√ß√£o Acumulada': { type: 'line', color: 'rgb(0, 0, 0)', borderColor: 'rgb(0, 0, 0)', pointStyle: 'circle', yAxisID: 'y1' },
            'Suc√ß√£o': { type: 'line', color: 'rgb(75, 192, 192)', borderColor: 'rgb(75, 192, 192)', pointStyle: 'triangle', yAxisID: 'y1' },
            '¬∞C Temp_Solo': { type: 'line', color: 'rgb(255, 99, 132)', borderColor: 'rgb(255, 99, 132)', pointStyle: 'star', yAxisID: 'y1' }
            // Adicione mais colunas aqui se houver e defina seus estilos e eixos
        };
        const defaultEstacaoStyle = { type: 'line', color: 'rgb(100, 100, 100)', borderColor: 'rgb(100, 100, 100)', pointStyle: 'cross', yAxisID: 'y1' };


        const verticalLinePlugin = {
          id: 'verticalLine',
          afterDraw: (chart) => { if (chart.tooltip?._active?.length) { const ctx = chart.ctx; const x = chart.tooltip._active[0].element.x; const topY = chart.scales.y.top; const bottomY = chart.scales.y.bottom; ctx.save(); ctx.beginPath(); ctx.moveTo(x, topY); ctx.lineTo(x, bottomY); ctx.lineWidth = 1; ctx.strokeStyle = 'rgba(0, 0, 0, 0.7)'; ctx.stroke(); ctx.restore(); } }
        };
        
        // --- Fun√ß√µes de Carregamento e Inicializa√ß√£o ---

        async function carregarTodosOsDados() {
            try {
                // Carrega os dois conjuntos de dados em paralelo
                const [responseSensores, responsePluviometria] = await Promise.all([
                    fetch("/dados_json"),
                    fetch("/pluviometria_json")
                ]);
                todosOsDadosSensores = await responseSensores.json();
                todosOsDadosPluviometria = await responsePluviometria.json();

                if (todosOsDadosSensores.error || todosOsDadosPluviometria.error) {
                    document.getElementById("tabela-container").innerHTML = `<div class="loading">Erro: ${todosOsDadosSensores.error || todosOsDadosPluviometria.error}</div>`;
                    return;
                }
                
                // Inicia as visualiza√ß√µes
                iniciarVisualizacaoSensores();
                iniciarVisualizacaoPluviometria();
                
                intervalId = setInterval(adicionarProximoDado, 2000);

            } catch (error) {
                document.getElementById("tabela-container").innerHTML = `<div class="loading">Erro de conex√£o: ${error}</div>`;
            }
        }

        function iniciarVisualizacaoSensores() {
            const cabecalho = Object.keys(todosOsDadosSensores[0]);
            criarTabelaComCabecalho(cabecalho);
            iniciarGraficoSensores(cabecalho);
        }

        function iniciarVisualizacaoPluviometria() {
            const cabecalho = Object.keys(todosOsDadosPluviometria[0]);
            iniciarGraficoPluviometria(cabecalho);
        }

        function criarTabelaComCabecalho(colunas) {
            const container = document.getElementById('tabela-container');
            container.innerHTML = `<h2>Dados dos Sensores de Umidade</h2><table><thead><tr>${colunas.map(col => `<th>${col}</th>`).join('')}</tr></thead><tbody></tbody></table>`;
        }

        // --- Fun√ß√µes dos Gr√°ficos ---

        function iniciarGraficoSensores(colunas) {
            const ctx = document.getElementById('graficoSensores').getContext('2d');
            const datasets = colunas.slice(1).map((col, i) => ({
                label: LABELS_PROFUNDIDADE[i] || col, data: [], borderColor: ESTILOS_SENSORES[i].color, backgroundColor: ESTILOS_SENSORES[i].color,
                pointStyle: ESTILOS_SENSORES[i].pointStyle, pointRadius: 5, pointHoverRadius: 7, tension: 0.1, fill: false
            }));
            graficoSensores = new Chart(ctx, {
                type: 'line', data: { labels: [], datasets: datasets },
                options: { responsive: true, interaction: { mode: 'index', intersect: false }, plugins: { legend: { position: 'bottom' } }, scales: { x: { ticks: { maxRotation: 45, minRotation: 45 } }, y: { title: { display: true, text: 'Umidade Volumetrica (%)' } } } },
                plugins: [verticalLinePlugin]
            });
        }

        // ALTERA√á√ÉO: Configura√ß√£o para gr√°fico de combina√ß√£o (barras e linhas)
        function iniciarGraficoPluviometria(colunas) {
            const ctx = document.getElementById('graficoPluviometria').getContext('2d');
            
            const datasets = colunas.slice(1).map(col => {
                const estilo = ESTILOS_ESTACAO[col] || defaultEstacaoStyle; // Pega estilo espec√≠fico ou padr√£o
                return {
                    label: col,
                    data: [],
                    type: estilo.type, // Define o tipo aqui (bar ou line)
                    borderColor: estilo.borderColor,
                    backgroundColor: estilo.color,
                    pointStyle: estilo.pointStyle,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    tension: (estilo.type === 'line' ? 0.1 : 0), // Linhas com tens√£o, barras sem
                    fill: false,
                    yAxisID: estilo.yAxisID // Associa ao eixo Y correto
                };
            });

            graficoPluviometria = new Chart(ctx, {
                type: 'bar', // Tipo padr√£o, mas os datasets individualmente podem ter outro
                data: { labels: [], datasets: datasets },
                options: { 
                    responsive: true, 
                    interaction: { mode: 'index', intersect: false }, 
                    plugins: { 
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: { // Adiciona unidade ao tooltip
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(2);
                                        if (context.dataset.label === 'Precipita√ß√£o' || context.dataset.label === 'Precipita√ß√£o Acumulada') {
                                            label += ' mm';
                                        } else if (context.dataset.label === '¬∞C Temp_Solo') {
                                            label += ' ¬∞C';
                                        }
                                    }
                                    return label;
                                }
                            }
                        }
                    }, 
                    scales: { 
                        x: { ticks: { maxRotation: 45, minRotation: 45 } }, 
                        y: { // Eixo Y para Precipita√ß√£o (barras)
                            position: 'left',
                            title: { display: true, text: 'Precipita√ß√£o (mm)' }, 
                            beginAtZero: true
                        },
                        y1: { // Eixo Y1 para outros dados (linhas)
                            position: 'right',
                            title: { display: true, text: 'Outros Valores' },
                            beginAtZero: false,
                            grid: { drawOnChartArea: false } // N√£o desenha grade para evitar polui√ß√£o visual
                        }
                    } 
                },
                plugins: [verticalLinePlugin]
            });
        }

        // --- Fun√ß√µes de Atualiza√ß√£o (Loop) ---

        function adicionarProximoDado() {
            let continuar = false;
            // Atualiza dados dos sensores
            if (indiceAtualSensores < todosOsDadosSensores.length) {
                dadosNaTelaSensores.unshift(todosOsDadosSensores[indiceAtualSensores++]); 
                if (dadosNaTelaSensores.length > 10) dadosNaTelaSensores.pop();
                continuar = true;
            }
            // Atualiza dados da esta√ß√£o
            if (indiceAtualPluviometria < todosOsDadosPluviometria.length) {
                dadosNaTelaPluviometria.unshift(todosOsDadosPluviometria[indiceAtualPluviometria++]);
                if (dadosNaTelaPluviometria.length > 10) dadosNaTelaPluviometria.pop();
                continuar = true;
            }

            renderizarTabelaSensores(); 
            atualizarGraficoSensores();
            atualizarGraficoPluviometria();

            if (!continuar) clearInterval(intervalId);
        }

        function renderizarTabelaSensores() {
            const tbody = document.querySelector("#tabela-container table tbody");
            if (!tbody) return;
            tbody.innerHTML = dadosNaTelaSensores.map(linha => `<tr>${Object.values(linha).map(val => `<td>${val === null ? '' : val}</td>`).join('')}</tr>`).join('');
        }

        function atualizarGraficoSensores() {
            if (!graficoSensores || dadosNaTelaSensores.length === 0) return;
            const dadosParaGrafico = [...dadosNaTelaSensores].reverse();
            const labelKey = Object.keys(dadosParaGrafico[0])[0];
            graficoSensores.data.labels = dadosParaGrafico.map(d => d[labelKey]);
            Object.keys(dadosParaGrafico[0]).slice(1).forEach((coluna, index) => {
                if (graficoSensores.data.datasets[index])
                    graficoSensores.data.datasets[index].data = dadosParaGrafico.map(d => d[coluna]);
            });
            graficoSensores.update(); 
        }

        // ALTERA√á√ÉO: Atualiza todas as linhas/barras do gr√°fico da esta√ß√£o
        function atualizarGraficoPluviometria() {
            if (!graficoPluviometria || dadosNaTelaPluviometria.length === 0) return;
            const dadosParaGrafico = [...dadosNaTelaPluviometria].reverse();
            const labelKey = Object.keys(dadosParaGrafico[0])[0];
            graficoPluviometria.data.labels = dadosParaGrafico.map(d => d[labelKey]);
            Object.keys(dadosParaGrafico[0]).slice(1).forEach((coluna, index) => {
                if (graficoPluviometria.data.datasets[index])
                    graficoPluviometria.data.datasets[index].data = dadosParaGrafico.map(d => d[coluna]);
            });
            graficoPluviometria.update();
        }
        
        carregarTodosOsDados();
    </script>
</body>
</html>

