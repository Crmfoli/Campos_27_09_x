<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa de Monitoramento - Tempo Real</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body { margin: 0; padding: 0; }
    #map { width: 100%; height: 100vh; }
    .map-tooltip.leaflet-tooltip { background: none; border: none; box-shadow: none; font-size: 1.5em; font-weight: bold; color: #000000; text-shadow: 1px 1px 2px rgba(255,255,255,0.8); }
    .map-tooltip.leaflet-tooltip-top::before { border: none !important; }
    #info-panel { position: absolute; top: 10px; right: 10px; width: 300px; background: #f8f9f9; border: 1px solid #ccc; border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 1000; font-family: Arial, sans-serif; font-size: 14px; transition: background-color 0.5s ease; }
    #info-panel h3 { margin: 0; padding: 10px; background-color: #555; color: black; border-top-left-radius: 5px; border-top-right-radius: 5px; font-size: 16px; text-align: center; transition: background-color 0.5s ease; display: flex; align-items: center; justify-content: center; }
    .sirene-icon { color: yellow; font-size: 1.2em; text-shadow: 0 0 5px rgba(0,0,0,0.5); animation: sirene-flash 0.5s infinite alternate; }
    #header-text { margin: 0 8px; }
    @keyframes sirene-flash { from { color: yellow; } to { color: orange; } }
    #info-panel-content { padding: 15px; }
    #info-panel p { margin: 10px 0; display: flex; justify-content: space-between; }
    #timestamp-display { text-align: center; padding: 5px; background-color: rgba(0,0,0,0.5); color: white; position: absolute; bottom: 0; width: 100%; z-index: 1000; font-family: monospace; font-size: 1.2em; }
    @keyframes flash-animation { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    .flashing-alert { animation: flash-animation 1s infinite; }
  </style>
</head>
<body>
    <div id="map"></div>
    <div id="info-panel">
        <h3 id="info-panel-header">
            <span id="sirene-icon-start" class="sirene-icon fas" style="display: none;"></span>
            <span id="header-text">Carregando...</span>
            <span id="sirene-icon-end" class="sirene-icon fas" style="display: none;"></span>
        </h3>
        <div id="info-panel-content">
            <p><strong>Chuva Acumulada (72h):</strong> <span id="status-chuva">--</span> mm</p>
            <p><strong>Umidade Média do Solo:</strong> <span id="status-umidade">--</span></p>
        </div>
    </div>
    <div id="timestamp-display">Aguardando início da simulação...</div>

  <script>
    var localizacao = [-22.741620, -45.598395];
    
    var streetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    });

    var satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 19,
        attribution: 'Tiles &copy; Esri'
    });

    var map = L.map('map', {
        center: localizacao,
        zoom: 13,
        layers: [streetMap]
    });

    var baseMaps = {
        "Ruas": streetMap,
        "Satélite": satelliteMap
    };

    L.control.layers(baseMaps, null, { position: 'topleft' }).addTo(map);

    const createIcon = (color) => new L.Icon({
        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41], iconAnchor: [12, 41], tooltipAnchor: [0, -41], shadowSize: [41, 41]
    });

    const obsIcon      = createIcon('green');
    const atencaoIcon  = createIcon('yellow');
    const alertaIcon   = createIcon('red');
    const maximoIcon   = createIcon('violet');
    const errorIcon    = createIcon('grey');

    var marker = L.marker(localizacao, { icon: obsIcon }).addTo(map);
    marker.bindTooltip("...", { permanent: true, direction: 'top', className: 'map-tooltip', offset: [0, 18] });
    
    let totalPontos = 0, indiceSimulacao = 0, simInterval = null;
    let dadosWindow = null, checkWindowInterval = null; 
    const VELOCIDADE_SIMULACAO = 2000 / 144; // Velocidade original restaurada

    function formatarDataBR(dataStr) {
        if (!dataStr) return '';
        const [data, hora] = dataStr.split(' ');
        const [ano, mes, dia] = data.split('-');
        const [h, m] = hora.split(':');
        return `${dia}/${mes}/${ano} ${h}:${m}`;
    }

    function startOrResumeSimulation() {
        if (simInterval) clearInterval(simInterval);
        if (indiceSimulacao < totalPontos) {
            simInterval = setInterval(avancarSimulacao, VELOCIDADE_SIMULACAO);
        }
    }

    async function iniciarSimulacao() {
        try {
            const infoResponse = await fetch('/api/info_simulacao');
            const infoData = await infoResponse.json();
            totalPontos = infoData.total_pontos;
            if (totalPontos > 0) {
                startOrResumeSimulation();
            } else {
                document.getElementById('header-text').innerText = "Sem dados.";
            }
        } catch (e) { document.getElementById('header-text').innerText = "Erro ao iniciar."; }
    }

    function avancarSimulacao() {
        if (indiceSimulacao >= totalPontos) {
            clearInterval(simInterval);
            document.getElementById('timestamp-display').innerText = "Fim da Simulação";
            return;
        }
        fetch(`/api/status_alerta?indice=${indiceSimulacao}`)
            .then(res => res.json()).then(data => atualizarVisualizacao(data))
            .catch(err => { console.error("Erro:", err); clearInterval(simInterval); });
        indiceSimulacao++;
    }

    function atualizarVisualizacao(data) {
        if (!data || data.error) { marker.setIcon(errorIcon); marker.getTooltip().setContent('Erro'); return; }
        const { acumulado_chuva_72h, nivel_alerta, umidade_media_solo, timestamp } = data;
        
        marker.getTooltip().setContent(String(acumulado_chuva_72h));

        let nome_nivel, cor_header, cor_body, pinoIcon;
        const infoPanelHeader = document.getElementById('info-panel-header');
        const sireneIconStart = document.getElementById('sirene-icon-start');
        const sireneIconEnd = document.getElementById('sirene-icon-end');
        const headerText = document.getElementById('header-text');
        
        switch (nivel_alerta) {
            case 4:
                nome_nivel = "Nível 4: Alerta Máximo";
                pinoIcon = maximoIcon;
                cor_header = "#8e44ad";
                cor_body = "#E8DAEF";
                sireneIconStart.style.display = 'inline-block';
                sireneIconEnd.style.display = 'inline-block';
                sireneIconStart.className = 'sirene-icon fas fa-triangle-exclamation';
                sireneIconEnd.className = 'sirene-icon fas fa-triangle-exclamation';
                break;
            case 3:
                nome_nivel = "Nível 3: Alerta";
                pinoIcon = alertaIcon;
                cor_header = "#E53935";
                cor_body = "#FADBD8";
                sireneIconStart.style.display = 'none';
                sireneIconEnd.style.display = 'none';
                break;
            case 2:
                nome_nivel = "Nível 2: Atenção";
                pinoIcon = atencaoIcon;
                cor_header = "#F1C40F";
                cor_body = "#FCF3CF";
                sireneIconStart.style.display = 'none';
                sireneIconEnd.style.display = 'none';
                break;
            default:
                nome_nivel = "Nível 1: Observação";
                pinoIcon = obsIcon;
                cor_header = "#5cb85c";
                cor_body = "#D5F5E3";
                sireneIconStart.style.display = 'none';
                sireneIconEnd.style.display = 'none';
        }

        if (nivel_alerta >= 3) {
            infoPanelHeader.classList.add('flashing-alert');
        } else {
            infoPanelHeader.classList.remove('flashing-alert');
        }

        marker.setIcon(pinoIcon);

        const umidadeTexto = umidade_media_solo !== null ? `${(umidade_media_solo * 100).toFixed(1)}%` : 'N/A';
        
        headerText.innerText = nome_nivel;
        document.getElementById('status-chuva').innerText = acumulado_chuva_72h;
        document.getElementById('status-umidade').innerText = umidadeTexto;
        infoPanelHeader.style.backgroundColor = cor_header;
        document.getElementById('info-panel').style.backgroundColor = cor_body;
        
        document.getElementById('timestamp-display').innerText = formatarDataBR(timestamp);
    }

    document.addEventListener('DOMContentLoaded', iniciarSimulacao);

    marker.on('click', function () {
        if (simInterval) {
            clearInterval(simInterval);
            simInterval = null;
        }

        const url = `/dados?indice=${indiceSimulacao > 0 ? indiceSimulacao - 1 : 0}`;
        dadosWindow = window.open(url, "_blank");

        if (checkWindowInterval) clearInterval(checkWindowInterval);
        checkWindowInterval = setInterval(() => {
            if (dadosWindow && dadosWindow.closed) {
                clearInterval(checkWindowInterval);
                checkWindowInterval = null;
                startOrResumeSimulation();
            }
        }, 500);
    });
  </script>
</body>
</html>

